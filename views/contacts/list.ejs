<%- include('../partials/header') %>
<% const startIndex = ((typeof currentPage !== 'undefined' ? currentPage : 1) - 1) * (perPage || contacts.length); %>
<div class="mb-4">
  <div class="row align-items-center g-2">
    <div class="col-12 col-sm-auto">
      <h1 class="mb-0">Contacts</h1>
    </div>
    <div class="col-12 col-sm-auto ms-sm-auto">
      <button id="syncBtn" class="btn btn-success w-100 w-sm-auto">ðŸ“¥ Import From Google Sheet</button>
    </div>
  </div>
</div>

<!-- Desktop Table View -->
<div class="d-none d-lg-block">
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-light">
        <tr>
          <th style="width:60px;">#</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Last Call</th>
          <th>Notes</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
      <% contacts.forEach(function(c, idx){ %>
        <% var phoneLink = (c.phone || '').toString().replace(/\D/g, ''); %>
        <tr>
          <td><%= startIndex + idx + 1 %></td>
          <td><a href="/contacts/<%= c._id %>" class="text-decoration-none"><strong><%= c.name %></strong></a></td>
          <td><a href="tel:<%= c.phone %>" class="text-decoration-none"><%= c.phone %></a></td>
          <td><small><%= c.lastCallAt ? new Date(c.lastCallAt).toLocaleString() : '-' %></small></td>
          <td><span class="badge bg-info"><%= c.notesCount || 0 %></span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-primary call-btn" data-id="<%= c._id %>" data-phone="<%= c.phone %>" title="Call">ðŸ“ž</button>
            <a class="btn btn-sm btn-outline-secondary" href="/contacts/<%= c._id %>" title="Details">View</a>
            <a class="btn btn-sm btn-success ms-1" href="https://wa.me/<%= phoneLink %>?text=<%= encodeURIComponent('Hi ' + (c.name || '') ) %>" target="_blank" rel="noopener" title="WhatsApp">ðŸ’¬</a>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
</div>

<!-- Mobile List View -->
<div class="d-lg-none">
  <ul id="contactsMobileList" class="list-group list-group-flush">
    <% contacts.forEach(function(c, idx){ %>
      <% var phoneLink = (c.phone || '').toString().replace(/\D/g, ''); %>
      <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-1">
              <span class="badge bg-secondary me-2"><%= startIndex + idx + 1 %></span>
              <a href="/contacts/<%= c._id %>" class="text-decoration-none"><%= c.name %></a>
            </h6>
            <p class="mb-1">
              <small class="text-muted">ðŸ“ž</small>
              <a href="tel:<%= c.phone %>" class="text-decoration-none"><small><%= c.phone %></small></a>
            </p>
            <% if (c.lastCallAt) { %>
              <p class="mb-1">
                <small class="text-muted">Last: <%= new Date(c.lastCallAt).toLocaleDateString() %></small>
              </p>
            <% } %>
            <span class="badge bg-info"><%= c.notesCount || 0 %> notes</span>
          </div>
          <div class="ms-2 d-flex flex-column gap-2">
            <a class="btn btn-sm btn-primary" href="tel:<%= c.phone %>">ðŸ“ž</a>
            <a class="btn btn-sm btn-success" href="https://wa.me/<%= phoneLink %>?text=<%= encodeURIComponent('Hi ' + (c.name || '') ) %>" target="_blank" rel="noopener">ðŸ’¬</a>
            <a class="btn btn-sm btn-outline-secondary" href="/contacts/<%= c._id %>">â†’</a>
          </div>
        </div>
      </li>
    <% }) %>
</div>

<% if (totalPages && totalPages > 1) { %>
  <!-- Desktop / Tablet: full numeric pagination -->
  <nav aria-label="Contacts pagination" class="mt-3 d-none d-sm-block">
    <ul class="pagination justify-content-center flex-wrap">
      <li class="page-item <%= currentPage <= 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= Math.max(1, currentPage - 1) %>" tabindex="-1">Previous</a>
      </li>
      <% for (let p = 1; p <= totalPages; p++) { %>
        <li class="page-item <%= p === currentPage ? 'active' : '' %>"><a class="page-link" href="?page=<%= p %>"><%= p %></a></li>
      <% } %>
      <li class="page-item <%= currentPage >= totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= Math.min(totalPages, currentPage + 1) %>">Next</a>
      </li>
    </ul>
  </nav>

  <!-- Mobile: compact pagination with Prev/Next and page indicator -->
  <nav aria-label="Contacts pagination" class="mt-3 d-block d-sm-none">
    <ul class="pagination justify-content-center">
      <li class="page-item <%= currentPage <= 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= Math.max(1, currentPage - 1) %>" tabindex="-1">Prev</a>
      </li>
      <li class="page-item disabled align-self-center mx-2">
        <span class="page-link" id="mobilePageIndicator">Page <%= currentPage %> of <%= totalPages %></span>
      </li>
      <li class="page-item <%= currentPage >= totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= Math.min(totalPages, currentPage + 1) %>">Next</a>
      </li>
    </ul>
  </nav>
<% } %>

<% if (contacts.length === 0) { %>
  <div class="alert alert-info text-center py-4">
    <p class="mb-0">No contacts yet. <a href="/contacts/add" class="alert-link">Add one now!</a></p>
  </div>
<% } %>

<%- include('../partials/footer') %>

<script>
  window.contactPagination = {
    currentPage: <%= typeof currentPage !== 'undefined' ? currentPage : 1 %>,
    totalPages: <%= typeof totalPages !== 'undefined' ? totalPages : 1 %>,
    perPage: <%= typeof perPage !== 'undefined' ? perPage : 70 %>
  };
</script>
